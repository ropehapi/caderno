<div class="formattedText" data-external-links="">
                                <p>Como disse, vamos usar uma nova ferramenta, dentro da VPC, para filtrar melhor nossos acessos.</p>
<p>Vamos acessar o painel da VPC. No menu lateral, na parte de segurança, temos "<strong>ACLs da rede</strong>". ACL significa "<em>Access Control List</em>" ou "lista de controle de acesso".</p>
<p>Isso funciona exatamente igual a um firewall. A diferença é que podemos ter várias listas e cada uma dessas listas ter várias regras. E cada uma dessas listas de regras podem ser adicionadas a uma ou mais sub-redes.</p>
<p>Então, agora vamos criar uma regra na segunda sub-rede para que todo tráfego seja permitido a partir da primeira sub-rede e bloqueado se vier de outro lugar.</p>
<p>Na página de ACLs da rede, vamos clicar em "Criar Network ACL" e preencher os campos da seguinte forma. </p>
<p>No campo "nome" vou deixar <code>redes-ab</code>; no campo VPC usarei a VPC padrão, porque ainda é a única que eu tenho. No meu caso a VPC padrão é vpc-04145a57a0e077d62. Não vou adicionar tags. Por fim clicamos em "Criar Network ACL".</p>
<p>De volta à lista de ACLs da rede podemos editar o nome dessa ACL recém-criada a ser exibido na lista, vamos deixar conforme criamos: <code>redes a-b</code>.</p>
<p>Em seguida, podemos clicar no número de ID dessa ACL. Vai abrir uma página em que podemos ver as regras de entrada e veremos que todo o tráfego está bloqueado. Na aba de regras de saída todo o tráfego também está bloqueado.</p>
<p>Ou seja, se adicionarmos essa ACL a alguma sub-rede agora, essa sub-rede ficará inacessível, não conseguiremos entrar nem sair.</p>
<p>Então vamos adicionar alguma regra de entrada.  Para isso, vamos clicar em "Editar regras de entrada" e inserir informações da regra que queremos adicionar. </p>
<p>No campo "número da regra" é onde colocaremos a prioridade, a primeira regra que casar com as condições do pacote que está entrando ou saindo, será avaliada. Vamos inserir o número "1", para que seja a primeira regra definida.</p>
<p>No campo "Tipo", selecionaremos a opção "Todo o tráfego" e no campo "Origem" vamos inserir <code>172.31.0.0/20</code>. Ou seja, vamos permitir qualquer entrada desde que venha da rede 172.31.0.0/20. Qualquer coisa que vier da primeira sub-rede será permitido. Por fim, clicamos em "Salvar alterações".</p>
<p>Agora, em uma nova aba do navegador, vamos acessar o painel da EC2, vamos na lista de instâncias pegar o comando para acessar a <code>segunda-maquina</code> no terminal.</p>
<pre class="prettyprint"><code class="hljs language-sql">ssh <span class="hljs-operator">-</span>i "aws-ohio.pem" ec2<span class="hljs-operator">-</span><span class="hljs-keyword">user</span><span class="hljs-variable">@ec2</span><span class="hljs-number">-13</span><span class="hljs-number">-58</span><span class="hljs-number">-82</span><span class="hljs-number">-28.</span>us<span class="hljs-operator">-</span>east<span class="hljs-number">-2.</span>compute.amazonaws.com</code><button type="button" class="clipit">Copiar código</button></pre><p>Não deveríamos conseguir acessar, mas conseguimos. Porque? </p>
<p>Vamos voltar na aba VPC no navegador. Na ACL temos uma aba nomeada "Associações de sub-rede". Repare que a ACL não está conectada a nenhuma rede ainda. Isso que está faltando para funcionar corretamente.</p>
<p>Vamos clicar em "Editar associações de sub-rede" e deixaremos a rede b, <code>us-east-2b</code>, selecionada. E clicaremos em "Salvar alterações".</p>
<p>Agora, ao voltar para o terminal e tentarmos digitar alguma coisa, não conseguimos porque fomos desconectados. Depois de um tempo o terminal vai entender e liberar, mas para não perder muito tempo vamos abrir uma nova aba do terminal e acessar a pasta em que estávamos, a ".ssh".</p>
<pre class="prettyprint"><code class="hljs language-bash"><span class="hljs-built_in">cd</span> .ssh</code><button type="button" class="clipit">Copiar código</button></pre><p>Vamos, novamente, tentar conectar à segunda máquina.</p>
<pre class="prettyprint"><code class="hljs language-sql">ssh <span class="hljs-operator">-</span>i "aws-ohio.pem" ec2<span class="hljs-operator">-</span><span class="hljs-keyword">user</span><span class="hljs-variable">@ec2</span><span class="hljs-number">-13</span><span class="hljs-number">-58</span><span class="hljs-number">-82</span><span class="hljs-number">-28.</span>us<span class="hljs-operator">-</span>east<span class="hljs-number">-2.</span>compute.amazonaws.com</code><button type="button" class="clipit">Copiar código</button></pre><p>Note que não conseguimos mais, não temos mais acesso à segunda máquina.</p>
<p>Vamos interromper essa conexão e tentar conectar à primeira máquina. Mas vamos adicionar um parâmetro ao comando, depois de <code>ssh</code> colocaremos <code>-A</code>, isso vai enviar o agente ssh à máquina em que estamos nos conectando. Dessa forma, a chave de conexão <code>"aws-ohio.pem"</code> estará disponível na AWS também.</p>
<pre class="prettyprint"><code class="hljs language-css">ssh -<span class="hljs-selector-tag">A</span> -<span class="hljs-selector-tag">i</span> "aws-ohio<span class="hljs-selector-class">.pem</span>" ec2-user<span class="hljs-keyword">@ec2-13-58-7-162</span>.us-east-2.compute.amazonaws.com</code><button type="button" class="clipit">Copiar código</button></pre><p>Agora estamos acessando a primeira máquina da AWS. Agora, na primeira máquina da AWS faremos o seguinte comando:</p>
<pre class="prettyprint"><code class="hljs language-sql">ssh ec2<span class="hljs-operator">-</span><span class="hljs-keyword">user</span><span class="hljs-variable">@172</span><span class="hljs-number">.31</span><span class="hljs-number">.28</span><span class="hljs-number">.109</span></code><button type="button" class="clipit">Copiar código</button></pre><p>Não conseguimos. Mas você deve estar pensando que faltou alguma coisa. O que está acontecendo?</p>
<p>Vejamos o que já temos: o grupo de segurança está lá, estamos liberados para acessar e o agente ssh está liberado também. Mas por quê não estamos conseguindo?</p>
<p>Vamos interromper e voltar a uma explicação que dei no vídeo anterior sobre grupos de segurança. Falei que o grupo de segurança é <strong><em>stateful</em></strong>, então a todo tráfego que entra é permitido voltar também. Já quando trabalhamos com ACL não é assim.</p>
<p>Então, a conexão de SSH está indo, a segunda máquina está aceitando a conexão, mas não está podendo devolver nada. Então ela não responde com sucesso e a conexão não é feita.</p>
<p>Para corrigir isso, vamos voltar na nossa ACL e configurar também as regras de saída. Vamos clicar na aba "Regras de saída" e, em seguida, em "Editar regras de saída &gt; Adicionar nova regra". Vamos preencher os campos da seguinte maneira:</p>
<blockquote>
<p>Número da regra: 1</p>
<p>Tipo: Todo o tráfego</p>
<p>Protocolo: Tudo</p>
<p>Intervalo de portas: Tudo</p>
<p>Destino: 172.31.0.0/20</p>
<p>Permitir/negar: Permitir</p>
</blockquote>
<p>Assim vamos permitir todo o tráfego desde que seja para 172.31.0.0/20. Ou seja, permito a entrada de todo tráfego vindo da primeira sub-rede e permito toda a saída de tráfego para a primeira sub-rede. Vamos clicar em "Salvar alterações".</p>
<p>Agora, no terminal, podemos interromper o comando anterior. E, de novo, a partir da primeira máquina vamos tentar acessar a segunda máquina.</p>
<pre class="prettyprint"><code class="hljs language-sql">ssh ec2<span class="hljs-operator">-</span><span class="hljs-keyword">user</span><span class="hljs-variable">@172</span><span class="hljs-number">.31</span><span class="hljs-number">.28</span><span class="hljs-number">.109</span></code><button type="button" class="clipit">Copiar código</button></pre><p>Agora, sim, funcionou corretamente. Note que eu tive uma permissão negada por causa da chave pública. Então, só o comando para adicionar o agente não funcionou porque eu não anexei a chave <code>"aws-ohio.pem"</code> ao agent. Isso são detalhes de SSH. Mas, basicamente, o que aconteceu foi que liberei acesso à minha sub-rede B somente a partir da sub-rede A.</p>
<p>E liberei também o acesso de volta, porque a ACL é <strong><em>stateless</em></strong>. ACLs só permitem a entrada ou só permitem a saída. Se queremos que o pacote vá e volte é preciso adicionar duas regras, uma para entrada e uma para saída.</p>
<p>Note que o padrão é negar tudo, por isso tem aquela regra padrão no final de negar todo o tráfego. Então, é preciso adicionar tudo o que quisermos permitir.</p>
<p>No próximo vídeo entenderemos as diferenças entre grupos de segurança e ACLs.</p>
                        </div>