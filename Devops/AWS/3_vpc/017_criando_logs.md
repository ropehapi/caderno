<div class="formattedText" data-external-links="">
                                <p>Boas-vindas a mais um capítulo desse curso, onde já aprendemos muitas coisas sobre redes e VPC na AWS. Agora está na hora de controlarmos um pouco melhor o que estamos fazendo e também monitorar o que está acontecendo. Começaremos pelo <strong>monitoramento</strong>.</p>
<p>Quero poder gerar logs do que está acontecendo na rede, o que pode ser feito no nível de uma VPC, da sub-rede e até da <strong>interface de rede</strong>, que é a placa de rede da instância. Cada instância tem uma ou mais interfaces de rede, e poderíamos decidir monitorar apenas essa interface, assim como a sub-rede inteira ou a VPC inteira.</p>
<p>Existem várias formas de monitoramento, e faremos o nosso usando o <strong><em>CloudWatch</em></strong>. Podemos monitorar mandando logs para o S3, para o <em>CloudWatch</em>, entre outras opções. Usaremos o <em>CloudWatch</em> porque ele é uma opção justamente para o monitoramento de logs.</p>
<p>Sendo assim, na barra de buscas da AWS, pesquisaremos por "<em>CloudWatch</em>", e selecionaremos essa opção. Tudo o que precisaremos fazer nele é criar um novo <em>log group</em> (grupo de log).</p>
<p>Com o painel do <em>CloudWatch</em> aberto, no menu da esquerda acessaremos "Logs &gt; Grupo de logs". Na seção "Grupo de Logs", criaremos um novo grupo, pois ainda não temos nenhum. Então clicamos no botão laranja "Criar grupo de logs" no canto superior direito da seção.</p>
<p>O nome pode ser o que quiserem, eu vou nomear como "vpc-flow-logs". Na configuração de retenção deixaremos definido que nunca vai expirar, e não adicionaremos nada de criptografia, então o campo "KMS key ARN" ficará vazio. Também não adicionaremos Tags, então podemos clicar em "Criar" no canto inferior direito da página.</p>
<p>Antes de configurarmos para VPC mandar logs para esse grupo, precisamos de outra função. Para isso, na barra de busca pesquisaremos pelo "IAM", porque precisamos criar uma para nova função para toda ação que precisa de permissões.</p>
<p>Com o painel do IAM aberto, no menu da direita, dentro do "Gerenciamento de acesso", clicaremos em "Funções". Nessa seção, clicaremos no botão azul "Criar função" no canto superior direito.</p>
<p>Somos direcionados para uma nova página com o formulário de criação de funções. No "Tipo de entrada confiável" deixaremos "Serviço da AWS", que é a primeira opção, marcado. Em "Caso de uso" marcaremos o "EC2", que também é a primeira opção. Essas partes não são tão importantes, então podemos clicar em "Próximo", no canto inferior direito.</p>
<p>A tela atualiza para segunda etapa do formulário, onde poderíamos buscar uma política que faz sentido, mas na documentação da AWS já temos um JSON de uma política que funciona para este caso. Sendo assim, clicaremos no botão "Criar política" no canto superior direito da seção "Políticas de permissões".</p>
<p>Isso abre uma nova aba, onde na parte superior da janela temos duas abas, com as opções de criarmos um "Editor visual" ou um "JSON". Clicamos em "JSON" e, em seguida, acessaremos a documentação da AWS que mostra como é o JSON dessa política que criaremos.</p>
<p>Portanto vamos acessar a <a href="https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs-cwl.html#flow-logs-iam-role" rel="nofollow noopener" target="_blank">documentação sobre o "<em>IAM role for publishing flow logs to CloudWatch Logs</em> (Papel da IAM para publicação do fluxo de logs para o CloudWatch Logs)</a>. Nela temos o JSON da política necessária, então basta copiamos, clicando no botão de copiar no canto superior direito da caixa de código.</p>
<pre class="prettyprint"><code class="hljs language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"Version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2012-10-17"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"Statement"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"Effect"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Allow"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Action"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"logs:CreateLogGroup"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"logs:CreateLogStream"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"logs:PutLogEvents"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"logs:DescribeLogGroups"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"logs:DescribeLogStreams"</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Resource"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"*"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>   </code><button type="button" class="clipit">Copiar código</button></pre><p>Eu decidi acessar a documentação com vocês, ao invés de simplesmente ter copiado antes e colado, para mostrar que a documentação da AWS é uma companheira do dia a dia para quem gerencia contas e redes na AWS. Acreditem quando eu digo que vocês não irão decorar esse JSON, mas acessarão a documentação para copiar esse código e colar onde precisa.</p>
<p>O mesmo acontecerá com outros pedaços de política, então é importante começarem a se habituar com a documentação da AWS, principalmente se tratando de conteúdos mais avançados, como é o caso de VPC. Como já foi dito, VPC não é um conteúdo do dia a dia, que mexemos com constância. Trata-se de algo pontual que demanda saber pesquisar na documentação.</p>
<p>Voltando para página aba de criação de política, na seção "JSON" tem um campo de código com um código pré-existente. Apagaremos esse código e colaremos o JSON que copiamos da documentação. Com isso, o que estamos fazendo é permitindo a ações dentro da lista <code>"Action"</code>:</p>
<ul><li>Criar grupo de log;</li><li>Criar log <em>stream</em>;</li><li>Adicionar eventos nesses <em>streams</em>;</li><li>Descrever os grupos;</li><li>Descrever os <em>streams</em>;</li></ul>
<p>Em seguida, clicamos no botão azul escrito "Próximo" no canto inferior direito da página. Com isso somos direcionados para página de Tags e, como não precisamos adicionar nenhuma tag, clicamos em "Próximo novamente". A última página é a "Revisar política", com um formulário.</p>
<p>No campo "Nome" iremos nomear a tag como "<em>CloudWatchLogFlowPolicy</em>", mas pode ser o nome que quiserem. Esse é o único campo obrigatório, então depois de preenchê-lo podemos rolar para o final da página, onde clicaremos no botão azul escrito "Criar política", no canto inferior direito da página.</p>
<p>Depois de um tempo a página atualiza e recebemos uma mensagem dentro de um retângulo verde confirmando que nossa política foi criada. Podemos fechar essa aba e voltar para a aba com o formulário de criação de Funções, onde estamos na etapa de adicionar permissões.</p>
<p>No canto superior direito, ao lado esquerdo do botão "Criar política", tem um botão de atualização, onde clicaremos. Com isso, a política que acabamos de criar aparece na primeira posição a lista de permissões. Clicamos nela para selecioná-la e rolamos a tela para baixo. </p>
<p>Na parte inferior tem um campo opcional de limite de permissões, que não faz sentido para nós, então clicaremos apenas no botão de "Próximo" no canto inferior direito da tela. Assim a página é atualizada para terceira etapa do formulário, o de "Detalhes da função".</p>
<p>Primeiramente daremos um nome para essa função, no primeiro campo desse novo formulário. O nome será "<em>CloudWatchFlowLogs</em>". Em seguida temos o campo de "Descrição", que já está preenchido, e a seção "Etapa 1: Selecionar entidades confiáveis", que tem um campo de código e um botão "Editar" ao lado direito do título da seção.</p>
<p>Clicaremos no botão de "Editar", nos envia para primeira página do formulário de criação de função. Portanto vamos clicar no botão de "Próximo" no canto inferior da tela duas vezes para voltarmos para página onde estávamos antes e deixaremos essa "Etapa 1" para ser editada depois. Rolando a tela até o final, clicaremos no botão azul "Criar função" no canto inferior direito da tela.</p>
<p>Ele revisa todos os dados que preenchemos e cria nossa função, nos direcionando para a página com todas as funções. Clicaremos na função que acabamos de criar, ou seja, a "<em>CloudWatchFlowLogs</em>" para editarmos a função, já que ele não tinha nos permitido editar as permissões.</p>
<p>Com a tela da função aberta, vamos rolar página para baixo. Depois da seção de "Resumo", tem um menu horizontal onde clicaremos na segunda opção, que é "Relações de confiança". Nessa seção temos o título "Entidades Confiáveis" e, à direita dele, o botão "Editar política de confiança".</p>
<p>Feito isso, passamos para outra página com o título "Editar política de confiança", onde do lado esquerdo tem um campo de código e do lado direito um formulário, ambos para editarmos a política de confiança. Voltaremos para <a href="https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs-cwl.html#flow-logs-iam-role" rel="nofollow noopener" target="_blank">mesma documentação de antes</a>, onde rolando a página para baixo mais um pouco temos o código da <em>trust policy</em> (política de confiança).</p>
<p>Copiaremos esse JSON e vamos colar no campo de código da página "Editar política de confiança".</p>
<pre class="prettyprint"><code class="hljs language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"Version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2012-10-17"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"Statement"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"Effect"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Allow"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Principal"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"Service"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vpc-flow-logs.amazonaws.com"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sts:AssumeRole"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span> </code><button type="button" class="clipit">Copiar código</button></pre><p>Essa política de confiança está permitindo o acesso de "<em>vpc-flow-logs</em>", que é o acesso desses logs de fluxo de VPC. Basicamente isso, então podemos rolar para o final da página e clicar no botão azul escrito "Atualizar política", abaixo do formulário. Nossa política é atualizada e agora a função "<em>CloudWatchFlowLogs</em>" está pronta para ser utilizada.</p>
<p>Permitimos na política o <em>flow</em> logs, as permissões já estão com a política que criamos, então está tudo certo. Agora podemos criar o fluxo de logs que enviaremos da VPC para o CloudWatch. Para isso, voltaremos no painel da VPC.</p>
<blockquote>
<p><strong>Lembrete:</strong> Esse fluxo de logs pode ser criado a partir da VPC, de alguma sub-rede ou de uma interface de rede mais específica. Faremos direto do VPC por ser um local mais amplo.</p>
</blockquote>
<p>No painel do VPC, em "Recursos por região", selecionamos o "VPCs". Em seguida, após a atualização da página, selecionamos o "infra-vpc", que é nossa VPC. Depois, no canto superior direito da tela, ao lado do botão "Criar VPC", clicaremos em "Ações &gt; Criar log de fluxo".</p>
<p>Somos direcionados para outra página, onde podemos definir as "Configurações de log de fluxo". O campo "Nome" é opcional e podemos nomear como quisermos, mas escreveremos "flow-log".</p>
<p>Em seguida, podemos filtrar se queremos apenas os logs dos fluxo aceitos, apenas dos rejeitados ou dos dois, marcando a opção "Tudo". Marcaremos como "Tudo", que é a terceira.</p>
<p>Depois temos o "Intervalo máximo de agregação", que é quanto tempo ele irá armazenar e agregar esses logs antes de criar uma entrada no CloudWatch. Temos as opções de 10 minutos e de 1 minuto. Selecionaremos "1 minuto" para esse curso, que é a segunda, mas em um cenário real, 10 minutos seria o ideal para não criarmos vários streams.</p>
<p>O próximo campo é o "Destino", onde escolhemos o local para enviarmos os logs. As opções são:</p>
<ul><li>Enviar ao CloudWatch Logs;</li><li>Enviar a um bucket do Amazon S3";</li><li>Enviar para o Kinesis Firehose na mesma conta;</li><li>Enviar para o Kinesis Firehose em uma conta diferente;</li></ul>
<p>A opção do CloudWatch Logs já está marcada e manteremos assim.</p>
<p>Em seguida temos o campo para escolhermos o "Grupo de logs de destino", onde selecionaremos o "vpc-flow-logs", que criamos no CloudWatch. Depois escolheremos a "Função do IAM", ou seja, a "CloudWatchFlowLogs" que acabamos de criar.</p>
<p>Por fim, no "Formato do registro de logs" manteremos selecionado o "Formato padrão da AWS", mas poderíamos personalizar esse formato clicando na segunda opção, que é "Formato personalizado" e selecionar os atributos disponíveis dentro de uma lista.</p>
<p>Não adicionaremos tags, então podemos clicar no botão laranja "Criar log de fluxo" no canto inferior direito da página. Feito isso, nosso log de fluxo foi criado, mas tem um último detalhe.</p>
<p>Se acessarmos a <a href="https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs.html" rel="nofollow noopener" target="_blank">página da documentação "<em>VPC Flow Logs</em>"</a>, descobrimos que depois de criarmos esse fluxo de logs, pode levar vários minutos para esses dados começarem a ser coletados e publicados. Então não teremos esses dados de imediato, isso pode levar um tempo.</p>
<p>Por isso, continuaremos esse curso com outro assunto antes de conferirmos o CloudWatch, porque esses logs ainda não estarão disponíveis para nós. Entretanto, vamos acessar o CloudWatch para entendermos onde esses logs ficarão disponíveis.</p>
<p>Com o painel do CloudWatch aberto, no menu da direita acessaremos "Logs &gt; Grupo de logs". Clicaremos no "vpc-flow-logs" e, quando a página atualiza, rolamos até o final, onde está a seção "<em>Streams de log</em>". Nela teríamos um stream de log para cada agrupamento que ele fizer, mas, de novo, pode levar muito tempo para começar a publicar algo nessa seção.</p>
<p>Agora quero conversar com vocês sobre um assunto muito importante. Temos a "maquina-bd", que é a do banco de dados, em uma rede privada. Atualmente fazemos isso acessando o servidor web e, a partir dele, acessamos essa máquina. E como acessaríamos ela na vida real?</p>
<p>Eu vou deixar um "Para saber mais" com a técnica que já estamos aplicando e, em seguida, voltaremos para configurar um servidor que servirá como ponte na nossa sub-rede pública para acessarmos a sub-rede privada.</p>
                        </div>