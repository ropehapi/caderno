<div class="formattedText" data-external-links="">
                                <p>Agora já entendemos o conceito de <strong><em>bastion host</em></strong>, mas antes de configurá-lo no nosso projeto, quero mostrar que nossos logs de fluxo começaram a ser publicados. Perceberemos uma enorme quantidade de tentativas de conexão rejeitadas, porque as requisições começam a chegar quando temos uma máquina disponível com IP público.</p>
<p>Vamos abrir o EC2, onde configuraremos uma nova máquina que servirá apenas como <em>bastion host</em>. Então na seção "Recursos" do painel EC2 clicaremos em "Instâncias (em execução)". A página atualiza e, em seguida, clicamos em "Executar instâncias" no canto superior direito.</p>
<p>Essa nova instância se chamará "bastion-host" e, a partir disso, podemos seguir duas abordagens: ter um <em>bastion host</em> para cada máquina que quisermos acessar na nossa sub-rede privada ou um que serve para todos os cenários. Então imaginem que temos um banco de dados e um sistema de "mensagenria" e queremos logar nos dois. Nesse caso podemos ter um ou dois <em>bastion hosts</em>.</p>
<p>Eu, Vinicius, prefiro ter apenas um <em>bastion host</em>, porque conseguimos limitá-lo mais e permitir a conexão somente para as duas máquinas. Eu não vejo sentido em ter dois, mas já vi configurações de rede com mais de um <em>bastion host</em>, então é possível e vocês podem preferir assim para o cenário de vocês.</p>
<p>Continuando a criação da instância, ela será um Amazon Linux, mas vocês podem escolher uma imagem menor para esses cenários. Na verdade é bem comum que <em>bastion hosts</em> sejam máquinas menores e, portanto, tenham imagens menores. Contudo, como estamos com tudo em <em>free trial</em> (teste grátis), vamos seguir.</p>
<p>Usaremos novamente a "aws-ohio" como chave" e faremos as configurações de rede. Precisaremos que ela esteja na nossa VPC e esteja pública, então vamos habilitar o IP público, já que o bastion host precisa ser acessível pela Internet na porta SSH.</p>
<p>Criaremos um novo número de segurança, chamado "bastion-host", ou seja, um grupo de segurança específico para ele. E a descrição será "permitir-acesso-ssh-somente-ao-bastion-host". Vocês podem pensar em uma descrição melhor caso queiram.</p>
<p>Na seção de "Regras do grupo de segurança de entrada", o "Tipo" já veio configurado com o SSH, e em "Tipo de origem", o ideal é que não seja de qualquer lugar, então vamos trocar para "Meu IP".</p>
<p>Poderíamos adicionar mais regras de segurança, como as interfaces de rede que já vimos, mas nesse caso não tem necessidade disso. Essa, portanto, é nossa regra de segurança, apenas com uma regra de entrada. Também não vamos alterar nenhuma configuração de armazenamento, então podemos clicar em "Executar instância" no canto inferior direito.</p>
<p>Agora voltaremos para página de Instâncias, selecionaremos o "bastion-host" e descobriremos o "Endereços IPv4 privados". Copiaremos esse número, que no meu caso é o "10.0.6.112" e permitiremos a acesso à "maquina-bd" apenas através desse IP do <em>bastion host</em>, e não através da "maquina-web".</p>
<p>Para isso voltaremos aos grupos de segurança, então no menu esquerdo acessaremos "Rede e segurança &gt; <em>Security groups</em>". Nele temos o "ssh-web-bd". Clicaremos no ID dele para irmos para página de edição desse ID.</p>
<p>Somos movidos para página desse grupo de segurança, onde rolaremos para seção de "Regras de entrada" e clicaremos no botão "Editar regras de entrada", que é o terceiro botão à direita do título. Clicando nela, somos direcionados para outra página, onde no campo "Origem" removeremos o IP que está lá e adicionaremos o IP do <em>bastion host</em> que acabamos de copiar.</p>
<p>Com isso fizemos uma mudança. Não receberemos mais as conexões da "maquina-web", apenas do "bastion-host". Isso porque nossa "maquina-web" pode receber mais acessos, mas o <em>bastion host</em> só recebe acesso SSH da nossa máquina, ou seja, ele é um pouco mais restrito. Portanto, vamos clicar no botão "Salvar" no canto inferior direito.</p>
<p>A princípio temos tudo configurado, então vamos fazer um teste. Voltando para o painel EC2, acessaremos novamente a Instâncias e queremos acessar a "maquina-bd", que é a máquina de banco de dados, portanto copiaremos o IP privado dela.</p>
<p>Em seguida abriremos o terminal e passaremos o SSH com a chave, com <code>-i ./aws-ohio</code> e acessaremos usando o <code>ec2-user@ip-privado-maquinabd</code>. No meu caso ficou:</p>
<pre class="prettyprint"><code class="hljs language-css">ssh -<span class="hljs-selector-tag">i</span> ./aws-ohio<span class="hljs-selector-class">.pem</span> ec2-user<span class="hljs-keyword">@10</span>.0.130.4</code><button type="button" class="clipit">Copiar código</button></pre><p>Contudo, antes de acessar a "maquina-bd", precisamos passar o <em>bastion host</em>, que em alguns lugares também é chamado de <strong><em>jump host</em></strong>. Para isso, entre a chave e o IP da máquina, usamos o comando <code>-J</code> seguido de <code>ec2-user@ip-publico-do-bastion-host</code>.</p>
<p>Esse IP público encontramos no campo "Endereço IP atribuído automaticamente" nos dados de instância do "bastion-host", basta copiarmos o número, que é seguido de "[IP público]". Então o meu comando final ficou:</p>
<pre class="prettyprint"><code class="hljs language-sql">ssh <span class="hljs-operator">-</span>i .<span class="hljs-operator">/</span>aws<span class="hljs-operator">-</span>ohio.pem <span class="hljs-operator">-</span>J ec2<span class="hljs-operator">-</span><span class="hljs-keyword">user</span><span class="hljs-variable">@3</span><span class="hljs-number">.129</span><span class="hljs-number">.9</span><span class="hljs-number">.228</span> ec2<span class="hljs-operator">-</span><span class="hljs-keyword">user</span><span class="hljs-variable">@10</span><span class="hljs-number">.0</span><span class="hljs-number">.130</span><span class="hljs-number">.4</span></code><button type="button" class="clipit">Copiar código</button></pre><blockquote>
<p><strong>Observação:</strong> Essa opção existe desde a versão 7.3 do cliente SSH, então se tiverem uma versão mais antiga, precisarão atualizar para usar esse comando.</p>
</blockquote>
<p>Quando tentarmos fazer a conexão, receberemos a mensagem informando que o host será adicionado e se temos certeza que queremos continuar. Escrevemos "yes" e pressionamos "Enter" para adicionar. Isso leva um tempo a mais, porém no final recebemos a mensagem que estabelecemos conexão com nossa máquina privada.</p>
<p>Então conseguimos nos conectar a nossa máquina privada passando por um outro ponto na nossa rede. Eu informei que esse não é um curso de SSH, mas estou mostrando esse detalhe de SSH porque ele é muito comum.</p>
<p>Inclusive imaginem que essa "maquina-bd" com a qual nos conectamos realmente é uma máquina de banco de dados. Nesse caso, teremos no nosso cliente de banco de dados uma opção chamada "<em>bastion host</em>", "<em>jump host</em>" ou "<em>proxy</em>", dependendo do seu cliente. De toda forma, vocês também vão configurar essa parte. Portanto esse tipo de acesso é muito comum e como estamos falando de VPC e limitação de redes, é interessante conhecermos esse detalhe também.</p>
<p>Com isso limitamos mais o acesso, e agora só conseguimos acessar a máquina que está na sub-rede privada a partir de um <em>bastion host</em>, ou seja, uma máquina específica para isso. Também já conseguimos monitorar o que está acontecendo na nossa rede, porque criamos nossos logs.</p>
<p>Com isso temos um bom começo para termos uma VPC robusta. Aprendemos bastante, então no próximo vídeo eu volto para fazermos uma revisão do que aprendemos no curso.</p>
                        </div>